<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時匯率換算 - UNCLE FAT'S TOOL BOX</title>    
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a href="unitconv.html">單位換算</a>
        <a href="dateconv.html">日期時間換算</a>
        <a href="currency.html">貨幣匯率換算</a>
        <a href="passwordgen.html">密碼產生器</a>
    </div>

    <nav class="navbar">
        <span class="openbtn" onclick="openNav()">&#9776;</span>
        <a href="index.html" class="navbar-brand">UNCLE FAT'S TOOL BOX</a> <!-- 保持連結到首頁 -->
        <div id="datetime-display" class="nav-links"></div>
    </nav>

    <div class="container">
        <h2><center>貨幣匯率換算</center></h2>

        <div class="calculator-section">
            <div class="converter-controls">
                <button id="resetRateTableBtn" class="reset-btn">重設</button>
            </div>
            <div id="rateTableContainer" class="unit-converter-grid"></div>
            <div class="info-footer">
                <p id="lastUpdated" class="last-updated-info"></p>
                <p class="disclaimer-info">匯率資料來源為 <a href="https://www.exchangerate-api.com" target="_blank" rel="noopener">ExchangeRate-API</a>。本換算結果僅供參考，實際交易匯率以銀行公告為準。</p>
            </div>
        </div>
    </div>

    <script>
        // --- 導覽列時間更新 ---
        function updateDateTime() {
            const now = new Date();
            const dateTimeString = now.toLocaleString('sv-SE').replace('T', ' '); // YYYY-MM-DD HH:MM:SS
            
            const displayElement = document.getElementById('datetime-display');
            if (displayElement) {
                displayElement.textContent = dateTimeString;
            }
        }
        updateDateTime();
        setInterval(updateDateTime, 1000);

        /* Sidebar Functions */
        function openNav() {
            document.getElementById("mySidebar").style.width = "250px";
        }

        function closeNav() {
            document.getElementById("mySidebar").style.width = "0";
        }
        window.openNav = openNav;
        window.closeNav = closeNav;

        // --- 匯率換算邏輯 ---
        const lastUpdatedEl = document.getElementById('lastUpdated');
        const rateTableContainerEl = document.getElementById('rateTableContainer');
        const resetRateTableBtn = document.getElementById('resetRateTableBtn');

        const API_BASE_URL = 'https://open.er-api.com/v6/latest';
        const majorCurrencies = ['TWD', 'USD', 'EUR', 'JPY', 'KRW', 'CNY', 'HKD', 'SGD', 'THB', 'GBP', 'AUD', 'CAD', 'CHF', 'ZAR', 'SEK', 'NZD', 'PHP', 'IDR', 'VND', 'MYR'];
        const currencyNames = {
            TWD: '新台幣',
            USD: '美元',
            EUR: '歐元',
            JPY: '日圓',
            KRW: '韓元',
            CNY: '人民幣',
            HKD: '港幣',
            SGD: '新加坡幣',
            THB: '泰銖',
            GBP: '英鎊',
            AUD: '澳幣',
            CAD: '加拿大幣',
            CHF: '瑞士法郎',
            ZAR: '南非幣',
            SEK: '瑞典克朗',
            NZD: '紐西蘭幣',
            PHP: '菲律賓披索',
            IDR: '印尼盾',
            VND: '越南盾',
            MYR: '馬來西亞令吉',
        };

        // 更新頁尾的資訊
        function updateInfoFooter(data) {
            if (!data || !data.time_last_update_utc) {
                lastUpdatedEl.textContent = '';
                return;
            }
            const updateDate = new Date(data.time_last_update_utc);
            const utcTime = updateDate.toISOString().substring(0, 19).replace('T', ' ');
            const localTime = updateDate.toLocaleString('sv-SE');
            lastUpdatedEl.textContent = `匯率更新時間: ${localTime} (當地) / ${utcTime} (UTC)`;
        }

        // --- 主要貨幣換算表格 ---

        // 處理表格中的換算邏輯
        async function handleTableConversion(event) {
            const sourceInput = event.target;
            const sourceCurrency = sourceInput.dataset.currency;
            const sourceValue = parseFloat(sourceInput.value);

            // 如果輸入無效或為空，清空所有欄位
            if (isNaN(sourceValue) || sourceInput.value === '') {
                document.querySelectorAll('#rateTableContainer input').forEach(input => input.value = '');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/${sourceCurrency}`);
                const data = await response.json();
                if (data.result !== 'success') return;

                const rates = data.rates;
                majorCurrencies.forEach(currency => {
                    if (currency === sourceCurrency) return; // 跳過來源欄位
                    const targetInput = document.getElementById(`rate-input-${currency}`);
                    if (targetInput && rates[currency]) {
                        const convertedValue = sourceValue * rates[currency];
                        targetInput.value = parseFloat(convertedValue.toPrecision(8));
                    }
                });

                updateInfoFooter(data);
            } catch (error) {
                console.error('表格匯率換算錯誤:', error);
            }
        }

        // 初始化並生成表格
        function initializeRateTable() {
            majorCurrencies.forEach(currency => {
                const group = document.createElement('div');
                group.className = 'unit-input-group';

                const label = document.createElement('label');
                label.htmlFor = `rate-input-${currency}`;
                
                // 根據貨幣代碼取得對應的國家/地區代碼
                const countryCode = (currency === 'EUR' ? 'eu' : currency.substring(0, 2)).toLowerCase();
                const flagImgSrc = `https://flagcdn.com/${countryCode}.svg`;
                const flagImg = `<img src="${flagImgSrc}" alt="${currency}" class="currency-flag">`;
                label.innerHTML = `${flagImg} ${currencyNames[currency] || currency} <span class="currency-code">(${currency})</span>`;

                const input = document.createElement('input');
                input.type = 'number';
                input.id = `rate-input-${currency}`;
                input.dataset.currency = currency;

                group.appendChild(label);
                group.appendChild(input);
                rateTableContainerEl.appendChild(group);

                input.addEventListener('input', handleTableConversion);
            });

            resetRateTableBtn.addEventListener('click', () => {
                document.querySelectorAll('#rateTableContainer input').forEach(input => input.value = '');
            });
        }

        // 頁面載入時設定預設值 (1 美元)
        async function setDefaultValue() {
            const usdInput = document.getElementById('rate-input-USD');
            if (!usdInput) return;

            usdInput.value = 1;
            // 建立一個模擬的事件對象來觸發換算
            const event = new Event('input', { bubbles: true, cancelable: true });
            usdInput.dispatchEvent(event);
        }

        // 初始化
        async function initializePage() {
            initializeRateTable();
            await setDefaultValue();
        }

        document.addEventListener('DOMContentLoaded', initializePage);

    </script>
</body>
</html>
