<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>匯率換算 - UNCLE FAT'S TOOL BOX</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <nav class="navbar">
        <a href="index.html" class="navbar-brand">UNCLE FAT'S TOOL BOX</a>
        <div id="datetime-display" class="nav-links"></div>
    </nav>

    <div class="container">
        <h2><center>匯率換算</center></h2>

        <div class="calculator-section">
            <div id="currency-converter-app">
                <div class="currency-converter-controls">
                    <div class="form-group currency-group">
                        <select id="fromCurrency"></select>
                        <input type="number" id="fromAmount" value="1" min="0">
                    </div>
                    <div class="swap-rate-container">
                        <button id="swapBtn" title="交換貨幣">⇄</button>
                        <div id="rateDisplay"></div>
                    </div>
                    <div class="form-group currency-group">
                        <select id="toCurrency"></select>
                        <input type="number" id="toAmount" readonly>
                    </div>
                </div>
                <p id="lastUpdated" class="last-updated-info"></p>
                <center><p class="disclaimer-info">匯率資料來源為ExchangeRate-API</p></center>
                <center><p class="disclaimer-info">換算結果僅供參考，實際交易匯率以銀行公告為準。</p></center>
            </div>
        </div>
    </div>

    <script>
        // --- 導覽列時間更新 ---
        function updateDateTime() {
            const now = new Date();
            const dateTimeString = now.toLocaleString('sv-SE').replace('T', ' '); // YYYY-MM-DD HH:MM:SS
            
            const displayElement = document.getElementById('datetime-display');
            if (displayElement) {
                displayElement.textContent = dateTimeString;
            }
        }
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // --- 匯率換算邏輯 ---
        const fromCurrencyEl = document.getElementById('fromCurrency');
        const fromAmountEl = document.getElementById('fromAmount');
        const toCurrencyEl = document.getElementById('toCurrency');
        const toAmountEl = document.getElementById('toAmount');
        const swapBtn = document.getElementById('swapBtn');
        const rateDisplayEl = document.getElementById('rateDisplay');
        const lastUpdatedEl = document.getElementById('lastUpdated');

        // 更換為支援更廣泛貨幣 (包含 TWD) 的 API
        const API_BASE_URL = 'https://open.er-api.com/v6/latest';

        let currencyRates = {}; // 用於儲存匯率數據

        // 填充貨幣選項
        async function populateCurrencies() {
            try {
                // 獲取以美元為基礎的匯率表，從中提取所有支援的貨幣代碼
                const response = await fetch(`${API_BASE_URL}/USD`);
                const data = await response.json();
                const currencies = Object.keys(data.rates);

                for (const code of currencies) {
                    const option1 = new Option(code, code);
                    const option2 = new Option(code, code);
                    fromCurrencyEl.add(option1);
                    toCurrencyEl.add(option2);
                }

                // 設定預設選項
                fromCurrencyEl.value = 'USD'; // 美元
                toCurrencyEl.value = 'TWD';   // 新台幣

                calculate();
            } catch (error) {
                console.error('無法載入貨幣列表:', error);
                rateDisplayEl.textContent = '無法載入貨幣資料';
            }
        }

        // 計算匯率
        async function calculate() {
            const fromCurrency = fromCurrencyEl.value;
            const toCurrency = toCurrencyEl.value;
            const fromAmount = parseFloat(fromAmountEl.value);

            if (!fromCurrency || !toCurrency || isNaN(fromAmount)) {
                return;
            }

            rateDisplayEl.textContent = '計算中...';

            // 為了減少 API 請求，我們先獲取基礎貨幣的所有匯率
            try {
                const response = await fetch(`${API_BASE_URL}/${fromCurrency}`);
                const data = await response.json();

                if (data.result === 'success' && data.rates[toCurrency]) {
                    const rate = data.rates[toCurrency];
                    const toAmount = fromAmount * rate;
                    
                    toAmountEl.value = parseFloat(toAmount.toPrecision(8));
                    rateDisplayEl.textContent = `1 ${fromCurrency} = ${rate.toPrecision(6)} ${toCurrency}`;

                    const updateDate = new Date(data.time_last_update_utc);
                    const utcTime = updateDate.toISOString().substring(0, 19).replace('T', ' ');
                    const localTime = updateDate.toLocaleString('sv-SE');

                    lastUpdatedEl.textContent = `匯率更新時間: ${localTime} (當地) / ${utcTime} (UTC)`;
                } else {
                    rateDisplayEl.textContent = '無法取得匯率';
                }
            } catch (error) {
                console.error('匯率計算錯誤:', error);
                rateDisplayEl.textContent = '匯率查詢失敗';
            }
        }

        // 交換貨幣
        function swapCurrencies() {
            [fromCurrencyEl.value, toCurrencyEl.value] = [toCurrencyEl.value, fromCurrencyEl.value];
            calculate();
        }

        // 事件監聽
        fromCurrencyEl.addEventListener('change', calculate);
        fromAmountEl.addEventListener('input', calculate);
        toCurrencyEl.addEventListener('change', calculate);
        swapBtn.addEventListener('click', swapCurrencies);

        // 初始化
        document.addEventListener('DOMContentLoaded', populateCurrencies);

    </script>
</body>
</html>
